---
title: "Data Science HW-6"
author: "Kasturi Bhamidipati"
date: "2022-12-02"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggridges)
library(patchwork)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 9, 
  fig.height = 7,
  out.width = "95%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1 
 
# Problem 2 

## Importing and tidying data 

We want to import the `homicides` dataset and make the necessary changes as noted in the problem.

```{r importing homicide data, message = FALSE}
homicides = 
  read_csv("./data/homicide-data.csv") %>%
  janitor::clean_names()%>%
   mutate(
    city_state = str_c(city,state, sep = ","),
    victim_age = as.numeric(victim_age), 
    solved = as.numeric(disposition == "Closed by arrest"))%>%
  filter(
    !city_state %in% c("Dallas,TX", "Phoenix,AZ", "Kansas City,MO", "Tulsa,AL"),
    victim_race %in% c("Black", "White")
    ) %>% 
  select(victim_race, victim_age, victim_sex, city_state, solved)

```

## Baltimore `glm` 

For the city of Baltimore, MD, we want to use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. 

```{r baltimore glm}
baltimore_glm = 
  homicides %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(solved ~ victim_age + victim_sex + victim_race, 
      family = binomial(), 
      data = .) %>% 
  broom::tidy() %>% 
  janitor::clean_names()%>% 
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96*std_error),
         CI_upper = exp(estimate + 1.96*std_error))

baltimore_glm
```

### Men Vs. Women Adjusted OR and 95% CI
Now we want to obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.

```{r baltimore men vs women}
baltimore_glm %>%
  filter(term == "victim_sexMale") %>%
  select(OR, CI_lower, CI_upper) %>% 
  knitr::kable(digits = 3, col.names = c('Odds Ratio', 'Lower CI', 'Upper CI'))
```

Therefore, we see that the adjusted odds ratio and its 95% CI for solving homicides comparing male victims to female victims, keeping all else constant is OR (95% CI) = `r round(baltimore_glm %>% filter(term == "victim_sexMale") %>% pull(OR), 3)` (`r round(baltimore_glm %>% filter(term == "victim_sexMale") %>% pull(CI_lower), 3)`, `r round(baltimore_glm %>% filter(term == "victim_sexMale") %>% pull(CI_upper), 3)`).

## All cities `glm` 

Now we want to do the same for all cities in the dataset. 

```{r all cities glm}
homicides_glm = 
  homicides %>%
  nest(all_cities = -city_state) %>%
  mutate(all_glm = map(.x = all_cities, ~glm(solved ~ victim_age + victim_sex + victim_race,
         family = binomial(), data = .)),
         results = map(all_glm, broom::tidy))%>%
  select(-all_glm, -all_cities) %>% 
  unnest(cols = results) %>% 
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96 * std.error),
         CI_upper = exp(estimate + 1.96 * std.error)) %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state, OR, CI_lower, CI_upper)%>%
  knitr::kable(digits = 3, col.names = c('City, State','Odds Ratio', 'Lower CI', 'Upper CI'))

homicides_glm
```



